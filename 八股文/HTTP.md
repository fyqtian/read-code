### HTTP2

https://imququ.com/post/series.html [Jerry Qu](https://imququ.com/)

https://zhuanlan.zhihu.com/p/26559480

https://ye11ow.gitbooks.io/http2-explained/content/part2.html

https://httpwg.org/specs/rfc7540.html

https://httpwg.org/specs/rfc7541.html

https://imququ.com/post/series.html



https://imququ.com/post/protocol-negotiation-in-http2.html 协商升级

**帧：**HTTP/2 数据通信的最小单位消息：指 HTTP/2 中逻辑上的 HTTP 消息。例如请求和响应等，消息由一个或多个帧组成。

**流：**存在于连接中的一个虚拟通道。流可以承载双向消息，每个流都有一个唯一的整数ID。

HTTP/2 **采用二进制格式传输数据**，而非 HTTP 1.x **的文本格式**，二进制协议解析起来更高效。 HTTP / 1 的请求和响应报文，都是由起始行，首部和实体正文（可选）组成，各部分之间以**文本换行符分隔**。HTTP/2 将请求和响应数据分割为更小的帧，并且它们采用二进制编码。

**HTTP/2 中，同域名下所有通信都在单个连接上完成，该连接可以承载任意数量的双向数据流。**每个数据流都以消息的形式发送，**而消息又由一个或多个帧组成**。**多个帧之间可以乱序发送**，**根据帧首部的流标识可以重新组装。**







**多路复用**：允许单一的HTTP/2连接同时发起多重的请求-响应消息

**二进制分帧**： HTTP/2 会将所有传输的信息分割为帧（frame）,并对它们采用二进制格式的编码 ，其中 首部信息会被封装到 [HEADER](https://so.csdn.net/so/search?q=HEADER&spm=1001.2101.3001.7020) frame，而相应的 Request Body 则封装到 DATA frame 里面。



### 帧格式

![https://img-blog.csdn.net/20170405153816267?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvemh1eWlxdWFu/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast]()

- DATA：用于传输HTTP消息体；
- HEADERS：用于传输首部字段；
- SETTINGS：用于约定客户端和服务端的配置数据。比如设置初识的双向流量控制窗口大小；
- WINDOW_UPDATE：用于调整个别流或个别连接的流量
- PRIORITY： 用于指定或重新指定引用资源的优先级。
- RST_STREAM： 用于通知流的非正常终止。
- PUSH_ PROMISE： 服务端推送许可。
- PING： 用于计算往返时间，执行“ 活性” 检活。
- GOAWAY： 用于通知对端停止在当前连接中创建流。

流是连接中的一个**虚拟信道**，可以承载双向消息传输。**每个流有唯一整数标识符**。为了防止两端流ID冲突，**客户端发起的流具有奇数ID，服务器端发起的流具有偶数ID。** 
所有HTTP 2. 0 通信都在一个TCP连接上完成， 这个连接可以承载任意数量的双向数据流Stream。 相应地， 每个数据流以 消息的形式发送， 而消息由一 或多个帧组成， 这些帧可以乱序发送， 然后根据每个帧首部的流标识符重新组装。 



**首部压缩**：

在 HTTP/1 中，HTTP 请求和响应都是由「状态行、请求 / 响应头部、消息主体」三部分组成。一般而言，消息主体都会经过 gzip 压缩，**或者本身传输的就是压缩过后的二进制文件（例如图片、音频）**

但状态行和头部却没有经过任何压缩，直接以纯文本传输。

随着 Web 功能越来越复杂，每个页面产生的请求数也越来越多，导致消耗在头部的流量越来越多，尤其是每次都要传输 UserAgent、Cookie 这类不会频繁变动的内容，完全是一种浪费。



 **头部压缩需要在支持 HTTP/2 的浏览器和服务端之间**：    

HTTP 1.1请求的大小变得越来越大，**有时甚至会大于TCP窗口的初始大小**，因为它们需要等待带着ACK的响应回来以后才能继续被发送。HTTP/2对消息头采用**HPACK**（专为http/2头部设计的压缩格式）进行压缩传输，能够节省消息头占用的网络的流量。而HTTP/1.x每次请求，都会携带大量冗余头信息，浪费了很多带宽资源。 

- HTTP/2在客户端和服务器端使用**“首部表”来跟踪和存储之前发送的键－值对**，对于相同的数据，不再通过每次请求和响应发送；
- 首部表在HTTP/2的连接存续期内始终存在，由客户端和服务器共同渐进地更新;
- 每个新的首部键－值对要么被追加到当前表的末尾，要么替换表中之前的值。



- 维护一份相同的静态字典（Static Table），包含常见的头部名称，以及特别常见的头部名称与值的组合；
- 维护一份相同的动态字典（Dynamic Table），可以动态的添加内容；
- 支持基于静态哈夫曼码表的哈夫曼编码（Huffman Coding）；



静态字典的作用有两个：

​      1）对于完全匹配的头部键值对，例如 “:method :GET”，可以直接使用一个字符表示；

​      2）对于头部名称可以匹配的键值对，例如 “cookie :xxxxxxx”，可以将名称使用一个字符表示。

同时，浏览器和服务端都可以向动态字典中添加键值对，之后这个键值对就可以使用一个字符表示了。需要注意的是，**动态字典上下文有关，需要为每个 HTTP/2 连接维护不同的字典**。在传输过程中使用，使用字符代替键值对大大减少传输的数据量。





### 哈夫曼编码

https://www.cnblogs.com/-citywall123/p/11297523.html