**Double write**

https://blog.csdn.net/longzhongxiaoniao/article/details/89221996



今天我们来介绍InnoDB存储引擎的第二个特性 - 两次写（doublewrite），如果说插入缓冲是为了提高写性能的话，那么两次写是为了**提高可靠性**，**牺牲了一点点写性能。**

部分写失效
想象这么一个场景，当数据库正在从内存向磁盘写一个数据页时，数据库宕机，从而导致这个页只写了部分数据，这就是部分写失效，它会导致数据丢失。这时是无法通过重做日志恢复的，因为重做日志记录的是对页的物理修改，如果页本身已经损坏，重做日志也无能为力。



**两次写机制**
从上面分析我们知道，在部分写失效的情况下，我们在**应用重做日志之前**，需要**原始页的一个副本**，两次写就是为了解决这个问题，下面是它的原理图：

<img src="..

/images/20130612080041468.jpg" alt="20130612080041468" style="zoom:75%;" />



两次写需要额外添加两个部分：
1）内存中的两次写缓冲（doublewrite buffer），大小为2MB
2）磁盘上共享表空间中连续的128页，大小也为2MB



其原理是这样的：
1）当**刷新缓冲池脏页时，并不直接写到数据文件中**，而是先拷贝至内存中的两次写缓冲区。
2）接着从两次写缓冲区**分两次写入磁盘共享表空间中，每次写入1MB**
3）待第2步完成后，再将两次写缓冲区写入数据文件

日志文件先行

这样就可以解决上文提到的部分写失效的问题，因为在磁盘共享表空间中已有数据页副本拷贝，**如果数据库在页写入数据文件的过程中宕机，在实例恢复时，可以从共享表空间中找到该页副本**，将其拷贝覆盖原有的数据页，再应用重做日志即可。

